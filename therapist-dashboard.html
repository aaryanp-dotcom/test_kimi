<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therapist Dashboard - MindSpace</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">
                <span>üß†</span> MindSpace
            </a>
            <ul class="nav-links">
                <li><a href="therapists.html">Browse Therapists</a></li>
                <li><a href="how-it-works.html">How It Works</a></li>
                <li><a href="contact.html">Support</a></li>
            </ul>
            <div class="nav-actions">
                <button id="profile-btn" class="btn btn-outline btn-sm">My Profile</button>
                <button id="logout-btn" class="btn btn-secondary btn-sm">Log Out</button>
            </div>
        </div>
    </nav>

    <!-- Dashboard -->
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <li><a href="#" class="active" data-section="bookings">My Appointments</a></li>
                <li><a href="#" data-section="profile">My Profile</a></li>
                <li><a href="contact.html">Help & Support</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>Therapist Dashboard</h1>
                <p>Manage your appointments and profile.</p>
            </div>

            <!-- Approval Status Banner -->
            <div id="approval-banner"></div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card" data-filter="all">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
                <div class="stat-card" data-filter="pending">
                    <div class="stat-value" id="stat-pending">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card" data-filter="confirmed">
                    <div class="stat-value" id="stat-confirmed">0</div>
                    <div class="stat-label">Confirmed</div>
                </div>
                <div class="stat-card" data-filter="completed">
                    <div class="stat-value" id="stat-completed">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>

            <!-- Filters Bar -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label class="filter-label">Search:</label>
                    <input type="text" id="search-input" class="form-input search-input" placeholder="Search by patient name or email...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status:</label>
                    <select id="status-filter" class="form-select">
                        <option value="all">All</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Date:</label>
                    <select id="date-filter" class="form-select">
                        <option value="all">All</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <button id="clear-filters" class="btn btn-secondary btn-sm">Clear Filters</button>
            </div>

            <!-- Bookings List -->
            <div id="bookings-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">My Profile</h3>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="profile-error"></div>
                <div id="profile-success"></div>
                <form id="profile-form">
                    <div class="grid grid-cols-2" style="gap: var(--spacing-md);">
                        <div class="form-group">
                            <label class="form-label required" for="profile-name">Name</label>
                            <input type="text" id="profile-name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="profile-email">Email</label>
                            <input type="email" id="profile-email" class="form-input" disabled>
                        </div>
                    </div>
                    <div class="grid grid-cols-2" style="gap: var(--spacing-md);">
                        <div class="form-group">
                            <label class="form-label" for="profile-phone">Phone</label>
                            <input type="tel" id="profile-phone" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label required" for="profile-fee">Session Fee (USD)</label>
                            <input type="number" id="profile-fee" class="form-input" min="1" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2" style="gap: var(--spacing-md);">
                        <div class="form-group">
                            <label class="form-label required" for="profile-specialization">Specialization</label>
                            <select id="profile-specialization" class="form-select" required>
                                <option value="">Select specialization</option>
                                <option value="Anxiety">Anxiety</option>
                                <option value="Depression">Depression</option>
                                <option value="Trauma">Trauma & PTSD</option>
                                <option value="Relationships">Relationships</option>
                                <option value="Family">Family Therapy</option>
                                <option value="Addiction">Addiction</option>
                                <option value="Eating Disorders">Eating Disorders</option>
                                <option value="Stress Management">Stress Management</option>
                                <option value="Grief">Grief & Loss</option>
                                <option value="LGBTQ+">LGBTQ+ Issues</option>
                                <option value="Career">Career Counseling</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required" for="profile-experience">Years of Experience</label>
                            <input type="number" id="profile-experience" class="form-input" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="profile-license">License / Qualifications</label>
                        <input type="text" id="profile-license" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="profile-bio">Professional Bio</label>
                        <textarea id="profile-bio" class="form-textarea" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button>
                <button class="btn btn-primary" id="save-profile-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Appointment</h3>
                <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="confirm-error"></div>
                <form id="confirm-form">
                    <input type="hidden" id="confirm-booking-id">
                    <div class="form-group">
                        <label class="form-label required" for="meeting-link">Meeting Link (https://)</label>
                        <input type="url" id="meeting-link" class="form-input" placeholder="https://zoom.us/j/..." required>
                        <p class="form-hint">Provide a secure HTTPS link for the video session</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-success" id="submit-confirm-btn">Confirm Appointment</button>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div id="reject-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Reject Appointment</h3>
                <button class="modal-close" onclick="closeRejectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="reject-error"></div>
                <form id="reject-form">
                    <input type="hidden" id="reject-booking-id">
                    <div class="form-group">
                        <label class="form-label required" for="reject-reason">Reason for Rejection</label>
                        <textarea id="reject-reason" class="form-textarea" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRejectModal()">Cancel</button>
                <button class="btn btn-danger" id="submit-reject-btn">Reject Appointment</button>
            </div>
        </div>
    </div>

    <!-- Complete Modal -->
    <div id="complete-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Mark Session Complete</h3>
                <button class="modal-close" onclick="closeCompleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="complete-error"></div>
                <form id="complete-form">
                    <input type="hidden" id="complete-booking-id">
                    <div class="form-group">
                        <label class="form-label" for="session-notes">Session Notes (visible to patient)</label>
                        <textarea id="session-notes" class="form-textarea" rows="4" maxlength="1000"></textarea>
                        <p class="form-hint">Maximum 1000 characters. These notes will be visible to the patient.</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCompleteModal()">Cancel</button>
                <button class="btn btn-success" id="submit-complete-btn">Mark Complete</button>
            </div>
        </div>
    </div>

    <!-- Suggest Reschedule Modal -->
    <div id="suggest-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Suggest New Time</h3>
                <button class="modal-close" onclick="closeSuggestModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="suggest-error"></div>
                <form id="suggest-form">
                    <input type="hidden" id="suggest-booking-id">
                    <div class="form-group">
                        <label class="form-label required" for="suggest-date">Suggested Date</label>
                        <input type="date" id="suggest-date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="suggest-time">Suggested Time</label>
                        <input type="time" id="suggest-time" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="suggest-reason">Reason</label>
                        <textarea id="suggest-reason" class="form-textarea" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSuggestModal()">Cancel</button>
                <button class="btn btn-primary" id="submit-suggest-btn">Send Suggestion</button>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="app.js"></script>
    <script>
        // Global state
        let currentUser = null;
        let currentProfile = null;
        let therapistRecord = null;
        let allBookings = [];
        let patientCache = {};

        // Initialize dashboard
        async function initDashboard() {
            const auth = await guardDashboard('therapist');
            if (!auth) return;
            
            currentUser = auth.user;
            currentProfile = auth.profile;
            
            // Load therapist record
            await loadTherapistRecord();
            
            // Show approval banner if pending
            showApprovalBanner();
            
            // Load bookings
            await loadBookings();
            
            // Setup event listeners
            setupEventListeners();
        }

        // Load therapist record
        async function loadTherapistRecord() {
            try {
                const { data, error } = await supabaseClient
                    .from('Therapists')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) {
                    console.error('Error loading therapist record:', error);
                    return;
                }
                
                therapistRecord = data;
            } catch (error) {
                console.error('Exception loading therapist record:', error);
            }
        }

        // Show approval status banner
        function showApprovalBanner() {
            const banner = document.getElementById('approval-banner');
            
            if (!therapistRecord) return;
            
            if (therapistRecord.approval_status === 'pending') {
                banner.innerHTML = `
                    <div class="alert alert-warning" style="margin-bottom: var(--spacing-lg);">
                        <strong>Account Pending Approval:</strong> Your therapist profile is under review. 
                        You'll be able to accept appointments once approved. This usually takes 1-2 business days.
                    </div>
                `;
            } else if (therapistRecord.approval_status === 'rejected') {
                banner.innerHTML = `
                    <div class="alert alert-error" style="margin-bottom: var(--spacing-lg);">
                        <strong>Account Not Approved:</strong> Your therapist application was not approved. 
                        Please contact support for more information.
                    </div>
                `;
            }
        }

        // Load bookings for this therapist
        async function loadBookings() {
            const container = document.getElementById('bookings-container');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            try {
                const { data: bookings, error } = await supabaseClient
                    .from('Bookings')
                    .select('*')
                    .eq('therapist_id', currentUser.id)
                    .order('session_date', { ascending: false });
                
                if (error) {
                    console.error('Error loading bookings:', error);
                    container.innerHTML = '<div class="alert alert-error">Failed to load bookings. Please try again.</div>';
                    return;
                }
                
                allBookings = bookings || [];
                
                // Pre-load patient details
                const userIds = [...new Set(allBookings.map(b => b.user_id))];
                await loadPatientDetails(userIds);
                
                // Update stats
                updateStats();
                
                // Render bookings
                renderBookings();
                
            } catch (error) {
                console.error('Exception loading bookings:', error);
                container.innerHTML = '<div class="alert alert-error">An error occurred. Please try again.</div>';
            }
        }

        // Load patient details into cache
        async function loadPatientDetails(userIds) {
            if (userIds.length === 0) return;
            
            try {
                const { data: patients, error } = await supabaseClient
                    .from('profiles')
                    .select('user_id, full_name, email, phone')
                    .in('user_id', userIds);
                
                if (error) {
                    console.error('Error loading patients:', error);
                    return;
                }
                
                patients.forEach(p => {
                    patientCache[p.user_id] = p;
                });
            } catch (error) {
                console.error('Exception loading patients:', error);
            }
        }

        // Update statistics
        function updateStats() {
            const total = allBookings.length;
            const pending = allBookings.filter(b => b.status === 'pending').length;
            const confirmed = allBookings.filter(b => b.status === 'confirmed').length;
            const completed = allBookings.filter(b => b.status === 'completed').length;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-confirmed').textContent = confirmed;
            document.getElementById('stat-completed').textContent = completed;
        }

        // Render bookings list
        function renderBookings() {
            const container = document.getElementById('bookings-container');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            
            // Filter bookings
            let filtered = allBookings.filter(booking => {
                // Search filter
                const patient = patientCache[booking.user_id];
                const patientName = patient ? (patient.full_name || '').toLowerCase() : '';
                const patientEmail = patient ? (patient.email || '').toLowerCase() : '';
                const bookingPatientName = (booking.patient_name || '').toLowerCase();
                const bookingPatientEmail = (booking.patient_email || '').toLowerCase();
                
                if (searchTerm && 
                    !patientName.includes(searchTerm) && 
                    !patientEmail.includes(searchTerm) &&
                    !bookingPatientName.includes(searchTerm) &&
                    !bookingPatientEmail.includes(searchTerm)) {
                    return false;
                }
                
                // Status filter
                if (statusFilter !== 'all' && booking.status !== statusFilter) {
                    return false;
                }
                
                // Date filter
                if (dateFilter !== 'all') {
                    const bookingDate = new Date(booking.session_date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const weekEnd = new Date(today);
                    weekEnd.setDate(weekEnd.getDate() + 7);
                    
                    const monthEnd = new Date(today);
                    monthEnd.setMonth(monthEnd.getMonth() + 1);
                    
                    if (dateFilter === 'today') {
                        const bookingDateOnly = new Date(bookingDate);
                        bookingDateOnly.setHours(0, 0, 0, 0);
                        if (bookingDateOnly.getTime() !== today.getTime()) {
                            return false;
                        }
                    } else if (dateFilter === 'week') {
                        if (bookingDate < today || bookingDate > weekEnd) {
                            return false;
                        }
                    } else if (dateFilter === 'month') {
                        if (bookingDate < today || bookingDate > monthEnd) {
                            return false;
                        }
                    }
                }
                
                return true;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <h3 class="empty-state-title">No appointments found</h3>
                        <p class="empty-state-description">You don't have any appointments matching your filters.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="bookings-list">' + filtered.map(booking => renderBookingCard(booking)).join('') + '</div>';
        }

        // Render single booking card
        function renderBookingCard(booking) {
            const patient = patientCache[booking.user_id];
            const patientName = patient ? (patient.full_name || 'Unknown') : (booking.patient_name || 'Unknown');
            const patientEmail = patient ? (patient.email || '') : (booking.patient_email || '');
            
            const statusBadgeClass = `badge-${booking.status}`;
            const isPending = booking.status === 'pending';
            const isConfirmed = booking.status === 'confirmed';
            const canConfirm = isPending && therapistRecord && therapistRecord.approval_status === 'approved';
            
            // Check for reschedule requests
            let rescheduleSection = '';
            
            if (booking.reschedule_requested) {
                rescheduleSection = `
                    <div class="alert alert-warning" style="margin-bottom: var(--spacing-md);">
                        <strong>Patient Requested Reschedule:</strong> 
                        ${formatDate(booking.reschedule_new_date)} at ${formatTime(booking.reschedule_new_start_time)}
                        <br><strong>Reason:</strong> ${booking.reschedule_reason || 'Not specified'}
                        <div style="margin-top: var(--spacing-sm);">
                            <button class="btn btn-success btn-sm" onclick="approveReschedule('${booking.id}')">Approve</button>
                            <button class="btn btn-danger btn-sm" onclick="rejectReschedule('${booking.id}')">Reject</button>
                        </div>
                    </div>
                `;
            }
            
            if (booking.therapist_reschedule_requested) {
                rescheduleSection += `
                    <div class="alert alert-info" style="margin-bottom: var(--spacing-md);">
                        <strong>You suggested reschedule:</strong> 
                        ${formatDate(booking.therapist_reschedule_date)} at ${formatTime(booking.therapist_reschedule_time)}
                        <br>Waiting for patient response.
                    </div>
                `;
            }
            
            return `
                <div class="booking-card">
                    <div class="booking-header">
                        <div>
                            <div class="booking-title">${patientName}</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${patientEmail}</div>
                        </div>
                        <span class="badge ${statusBadgeClass}">${booking.status}</span>
                    </div>
                    ${rescheduleSection}
                    <div class="booking-body">
                        <div class="booking-meta">
                            <span>üìÖ ${formatDate(booking.session_date)}</span>
                            <span>üïê ${formatTime(booking.start_time)}</span>
                            <span>üí∞ ${formatCurrency(booking.amount)}</span>
                        </div>
                        ${booking.problem_description ? `
                            <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background-color: var(--bg-secondary); border-radius: var(--border-radius);">
                                <strong>Patient's concern:</strong> ${booking.problem_description}
                            </div>
                        ` : ''}
                        ${booking.meeting_link && isConfirmed ? `
                            <div style="margin-top: var(--spacing-md);">
                                <strong>Meeting Link:</strong> 
                                <a href="${booking.meeting_link}" target="_blank" class="btn btn-sm btn-outline">Open Link</a>
                            </div>
                        ` : ''}
                    </div>
                    <div class="booking-footer">
                        <div style="font-size: var(--font-size-sm); color: var(--text-light);">
                            Booked on ${formatDate(booking.created_at)}
                        </div>
                        <div class="booking-actions">
                            ${canConfirm ? `
                                <button class="btn btn-success btn-sm" onclick="openConfirmModal('${booking.id}')">Confirm</button>
                                <button class="btn btn-danger btn-sm" onclick="openRejectModal('${booking.id}')">Reject</button>
                                <button class="btn btn-secondary btn-sm" onclick="openSuggestModal('${booking.id}')">Suggest Time</button>
                            ` : ''}
                            ${isConfirmed ? `
                                <button class="btn btn-success btn-sm" onclick="openCompleteModal('${booking.id}')">Mark Complete</button>
                                <button class="btn btn-secondary btn-sm" onclick="openSuggestModal('${booking.id}')">Suggest Reschedule</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Logout
            document.getElementById('logout-btn').addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.href = 'login.html';
            });
            
            // Profile button
            document.getElementById('profile-btn').addEventListener('click', openProfileModal);
            
            // Save profile
            document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
            
            // Search and filters
            document.getElementById('search-input').addEventListener('input', debounce(renderBookings, 300));
            document.getElementById('status-filter').addEventListener('change', renderBookings);
            document.getElementById('date-filter').addEventListener('change', renderBookings);
            
            // Clear filters
            document.getElementById('clear-filters').addEventListener('click', () => {
                document.getElementById('search-input').value = '';
                document.getElementById('status-filter').value = 'all';
                document.getElementById('date-filter').value = 'all';
                renderBookings();
            });
            
            // Stat card clicks
            document.querySelectorAll('.stat-card').forEach(card => {
                card.addEventListener('click', () => {
                    const filter = card.dataset.filter;
                    if (filter === 'all') {
                        document.getElementById('status-filter').value = 'all';
                    } else {
                        document.getElementById('status-filter').value = filter;
                    }
                    renderBookings();
                });
            });
            
            // Modal submit buttons
            document.getElementById('submit-confirm-btn').addEventListener('click', submitConfirm);
            document.getElementById('submit-reject-btn').addEventListener('click', submitReject);
            document.getElementById('submit-complete-btn').addEventListener('click', submitComplete);
            document.getElementById('submit-suggest-btn').addEventListener('click', submitSuggest);
        }

        // Open profile modal
        function openProfileModal() {
            if (!therapistRecord) return;
            
            // Populate form
            document.getElementById('profile-name').value = therapistRecord.Name || '';
            document.getElementById('profile-email').value = therapistRecord.email || '';
            document.getElementById('profile-phone').value = therapistRecord.phone || '';
            document.getElementById('profile-fee').value = therapistRecord.fee || '';
            document.getElementById('profile-specialization').value = therapistRecord.Specialization || '';
            document.getElementById('profile-experience').value = therapistRecord.experience || '';
            document.getElementById('profile-license').value = therapistRecord.license || '';
            document.getElementById('profile-bio').value = therapistRecord.bio || '';
            
            // Clear messages
            document.getElementById('profile-error').innerHTML = '';
            document.getElementById('profile-success').innerHTML = '';
            
            // Show modal
            document.getElementById('profile-modal').classList.remove('hidden');
        }

        // Close profile modal
        function closeProfileModal() {
            document.getElementById('profile-modal').classList.add('hidden');
        }

        // Save profile
        async function saveProfile() {
            const errorContainer = document.getElementById('profile-error');
            const successContainer = document.getElementById('profile-success');
            const saveBtn = document.getElementById('save-profile-btn');
            
            errorContainer.innerHTML = '';
            successContainer.innerHTML = '';
            
            // Get values
            const name = document.getElementById('profile-name').value.trim();
            const phone = document.getElementById('profile-phone').value.trim();
            const fee = parseInt(document.getElementById('profile-fee').value, 10);
            const specialization = document.getElementById('profile-specialization').value;
            const experience = parseInt(document.getElementById('profile-experience').value, 10);
            const license = document.getElementById('profile-license').value.trim();
            const bio = document.getElementById('profile-bio').value.trim();
            
            if (!name || !fee || !specialization || !license || !bio) {
                errorContainer.innerHTML = '<div class="error-message">Please fill in all required fields.</div>';
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                const { error } = await supabaseClient
                    .from('Therapists')
                    .update({
                        Name: name,
                        phone: phone || null,
                        fee: fee,
                        Specialization: specialization,
                        experience: experience || 0,
                        license: license,
                        bio: bio
                    })
                    .eq('id', currentUser.id);
                
                if (error) {
                    console.error('Error saving profile:', error);
                    errorContainer.innerHTML = `<div class="error-message">Failed to save profile: ${error.message}</div>`;
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                    return;
                }
                
                // Update local record
                therapistRecord = {
                    ...therapistRecord,
                    Name: name,
                    phone: phone,
                    fee: fee,
                    Specialization: specialization,
                    experience: experience,
                    license: license,
                    bio: bio
                };
                
                successContainer.innerHTML = '<div class="success-message">Profile saved successfully!</div>';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
                
            } catch (error) {
                console.error('Exception saving profile:', error);
                errorContainer.innerHTML = '<div class="error-message">An error occurred. Please try again.</div>';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        // Confirm modal
        function openConfirmModal(bookingId) {
            document.getElementById('confirm-booking-id').value = bookingId;
            document.getElementById('meeting-link').value = '';
            document.getElementById('confirm-error').innerHTML = '';
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        async function submitConfirm() {
            const bookingId = document.getElementById('confirm-booking-id').value;
            const meetingLink = document.getElementById('meeting-link').value.trim();
            const errorContainer = document.getElementById('confirm-error');
            const submitBtn = document.getElementById('submit-confirm-btn');
            
            errorContainer.innerHTML = '';
            
            if (!meetingLink) {
                errorContainer.innerHTML = '<div class="error-message">Please provide a meeting link.</div>';
                return;
            }
            
            if (!isValidHttpsUrl(meetingLink)) {
                errorContainer.innerHTML = '<div class="error-message">Meeting link must be a valid HTTPS URL.</div>';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Confirming...';
            
            try {
                const { error } = await supabaseClient
                    .from('Bookings')
                    .update({
                        status: 'confirmed',
                        meeting_link: meetingLink,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', bookingId)
                    .eq('therapist_id', currentUser.id);
                
                if (error) {
                    console.error('Error confirming booking:', error);
                    errorContainer.innerHTML = `<div class="error-message">Failed to confirm: ${error.message}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Confirm Appointment';
                    return;
                }
                
                closeConfirmModal();
                await loadBookings();
                showSuccess('Appointment confirmed successfully!');
                
            } catch (error) {
                console.error('Exception confirming booking:', error);
                errorContainer.innerHTML = '<div class="error-message">An error occurred. Please try again.</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Confirm Appointment';
            }
        }

        // Reject modal
        function openRejectModal(bookingId) {
            document.getElementById('reject-booking-id').value = bookingId;
            document.getElementById('reject-reason').value = '';
            document.getElementById('reject-error').innerHTML = '';
            document.getElementById('reject-modal').classList.remove('hidden');
        }

        function closeRejectModal() {
            document.getElementById('reject-modal').classList.add('hidden');
        }

        async function submitReject() {
            const bookingId = document.getElementById('reject-booking-id').value;
            const reason = document.getElementById('reject-reason').value.trim();
            const errorContainer = document.getElementById('reject-error');
            const submitBtn = document.getElementById('submit-reject-btn');
            
            errorContainer.innerHTML = '';
            
            if (!reason) {
                errorContainer.innerHTML = '<div class="error-message">Please provide a reason.</div>';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Rejecting...';
            
            try {
                const { error } = await supabaseClient
                    .from('Bookings')
                    .update({
                        status: 'rejected',
                        therapist_reschedule_reason: reason,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', bookingId)
                    .eq('therapist_id', currentUser.id);
                
                if (error) {
                    console.error('Error rejecting booking:', error);
                    errorContainer.innerHTML = `<div class="error-message">Failed to reject: ${error.message}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Reject Appointment';
                    return;
                }
                
                closeRejectModal();
                await loadBookings();
                showSuccess('Appointment rejected.');
                
            } catch (error) {
                console.error('Exception rejecting booking:', error);
                errorContainer.innerHTML = '<div class="error-message">An error occurred. Please try again.</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Reject Appointment';
            }
        }

        // Complete modal
        function openCompleteModal(bookingId) {
            document.getElementById('complete-booking-id').value = bookingId;
            document.getElementById('session-notes').value = '';
            document.getElementById('complete-error').innerHTML = '';
            document.getElementById('complete-modal').classList.remove('hidden');
        }

        function closeCompleteModal() {
            document.getElementById('complete-modal').classList.add('hidden');
        }

        async function submitComplete() {
            const bookingId = document.getElementById('complete-booking-id').value;
            const notes = document.getElementById('session-notes').value.trim();
            const errorContainer = document.getElementById('complete-error');
            const submitBtn = document.getElementById('submit-complete-btn');
            
            errorContainer.innerHTML = '';
            
            if (notes.length > 1000) {
                errorContainer.innerHTML = '<div class="error-message">Notes must be 1000 characters or less.</div>';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Completing...';
            
            try {
                const { error } = await supabaseClient
                    .from('Bookings')
                    .update({
                        status: 'completed',
                        next_session_notes: notes,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', bookingId)
                    .eq('therapist_id', currentUser.id);
                
                if (error) {
                    console.error('Error completing booking:', error);
                    errorContainer.innerHTML = `<div class="error-message">Failed to complete: ${error.message}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Mark Complete';
                    return;
                }
                
                closeCompleteModal();
                await loadBookings();
                showSuccess('Session marked as complete!');
                
            } catch (error) {
                console.error('Exception completing booking:', error);
                errorContainer.innerHTML = '<div class="error-message">An error occurred. Please try again.</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Mark Complete';
            }
        }

        // Suggest reschedule modal
        function openSuggestModal(bookingId) {
            document.getElementById('suggest-booking-id').value = bookingId;
            document.getElementById('suggest-date').value = '';
            document.getElementById('suggest-time').value = '';
            document.getElementById('suggest-reason').value = '';
            document.getElementById('suggest-error').innerHTML = '';
            document.getElementById('suggest-modal').classList.remove('hidden');
        }

        function closeSuggestModal() {
            document.getElementById('suggest-modal').classList.add('hidden');
        }

        async function submitSuggest() {
            const bookingId = document.getElementById('suggest-booking-id').value;
            const date = document.getElementById('suggest-date').value;
            const time = document.getElementById('suggest-time').value;
            const reason = document.getElementById('suggest-reason').value.trim();
            const errorContainer = document.getElementById('suggest-error');
            const submitBtn = document.getElementById('submit-suggest-btn');
            
            errorContainer.innerHTML = '';
            
            if (!date || !time || !reason) {
                errorContainer.innerHTML = '<div class="error-message">Please fill in all fields.</div>';
                return;
            }
            
            if (!isFutureDate(date)) {
                errorContainer.innerHTML = '<div class="error-message">Date must be in the future.</div>';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            
            try {
                const { error } = await supabaseClient
                    .from('Bookings')
                    .update({
                        therapist_reschedule_requested: true,
                        therapist_reschedule_date: date,
                        therapist_reschedule_time: time,
                        therapist_reschedule_reason: reason,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', bookingId)
                    .eq('therapist_id', currentUser.id);
                
                if (error) {
                    console.error('Error suggesting reschedule:', error);
                    errorContainer.innerHTML = `<div class="error-message">Failed to send: ${error.message}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Suggestion';
                    return;
                }
                
                closeSuggestModal();
                await loadBookings();
                showSuccess('Reschedule suggestion sent!');
                
            } catch (error) {
                console.error('Exception suggesting reschedule:', error);
                errorContainer.innerHTML = '<div class="error-message">An error occurred. Please try again.</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Suggestion';
            }
        }

        // Approve patient reschedule request
        async function approveReschedule(bookingId) {
            if (!confirm('Approve this reschedule request?')) return;
            
            try {
                const booking = allBookings.find(b => b.id === bookingId);
                if (!booking) return;
                
                const { error } = await supabaseClient
                    .from('Bookings')
                    .update({
                        session_date: booking.reschedule_new_date,
                        start_time: booking.reschedule_new_start_time,
                        reschedule_requested: false,
                        reschedule_new_date: null,
                        reschedule_new_start_time: null,
                        reschedule_reason: null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', bookingId)
                    .eq('therapist_id', currentUser.id);
                
                if (error) {
                    console.error('Error approving reschedule:', error);
                    alert('Failed to approve reschedule. Please try again.');
                    return;
                }
                
                await loadBookings();
                showSuccess('Reschedule approved!');
                
            } catch (error) {
                console.error('Exception approving reschedule:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Reject patient reschedule request
        async function rejectReschedule(bookingId) {
            if (!confirm('Reject this reschedule request?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('Bookings')
                    .update({
                        reschedule_requested: false,
                        reschedule_new_date: null,
                        reschedule_new_start_time: null,
                        reschedule_reason: null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', bookingId)
                    .eq('therapist_id', currentUser.id);
                
                if (error) {
                    console.error('Error rejecting reschedule:', error);
                    alert('Failed to reject reschedule. Please try again.');
                    return;
                }
                
                await loadBookings();
                showSuccess('Reschedule request rejected.');
                
            } catch (error) {
                console.error('Exception rejecting reschedule:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
