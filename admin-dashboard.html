<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MindSpace</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">
                <span>ðŸ§ </span> MindSpace
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="therapists.html">Therapists</a></li>
            </ul>
            <div class="nav-actions">
                <span style="font-size: var(--font-size-sm); color: var(--text-secondary);">Admin</span>
                <button id="logout-btn" class="btn btn-secondary btn-sm">Log Out</button>
            </div>
        </div>
    </nav>

    <!-- Dashboard -->
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <li><a href="#" class="active" data-section="overview">Overview</a></li>
                <li><a href="#" data-section="pending">Pending Applications</a></li>
                <li><a href="#" data-section="therapists">All Therapists</a></li>
                <li><a href="#" data-section="patients">All Patients</a></li>
                <li><a href="#" data-section="bookings">All Bookings</a></li>
                <li><a href="#" data-section="revenue">Revenue</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>Admin Dashboard</h1>
                <p>Platform administration and analytics.</p>
            </div>

            <!-- Platform Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-therapists">0</div>
                    <div class="stat-label">Total Therapists</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-patients">0</div>
                    <div class="stat-label">Total Patients</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-bookings">0</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-revenue">$0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
            </div>

            <!-- Pending Applications Section -->
            <section id="pending-section" style="margin-bottom: var(--spacing-2xl);">
                <h2 style="margin-bottom: var(--spacing-lg);">Pending Therapist Applications</h2>
                <div id="pending-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </section>

            <!-- All Therapists Section -->
            <section id="therapists-section" style="margin-bottom: var(--spacing-2xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                    <h2>All Therapists</h2>
                    <input type="text" id="therapist-search" class="form-input" placeholder="Search by name or specialization..." style="width: 300px;">
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Specialization</th>
                                <th>Fee</th>
                                <th>Status</th>
                                <th>Approval</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="therapists-table-body">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- All Patients Section -->
            <section id="patients-section" style="margin-bottom: var(--spacing-2xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                    <h2>All Patients</h2>
                    <input type="text" id="patient-search" class="form-input" placeholder="Search by name or email..." style="width: 300px;">
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>City</th>
                                <th>Joined</th>
                            </tr>
                        </thead>
                        <tbody id="patients-table-body">
                            <tr><td colspan="5" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- All Bookings Section -->
            <section id="bookings-section" style="margin-bottom: var(--spacing-2xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                    <h2>All Bookings</h2>
                    <div style="display: flex; gap: var(--spacing-md);">
                        <select id="booking-therapist-filter" class="form-select">
                            <option value="">All Therapists</option>
                        </select>
                        <select id="booking-status-filter" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Patient</th>
                                <th>Therapist</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-table-body">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Revenue Section -->
            <section id="revenue-section">
                <h2 style="margin-bottom: var(--spacing-lg);">Revenue Breakdown</h2>
                <div class="grid grid-cols-3" style="gap: var(--spacing-lg);">
                    <div class="card">
                        <div class="card-header">
                            <h4>By Therapist</h4>
                        </div>
                        <div class="card-body">
                            <div id="revenue-by-therapist">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h4>By Specialization</h4>
                        </div>
                        <div class="card-body">
                            <div id="revenue-by-specialization">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h4>Monthly Trend</h4>
                        </div>
                        <div class="card-body">
                            <div id="revenue-monthly">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="app.js"></script>
    <script>
        // Global state
        let currentUser = null;
        let currentProfile = null;
        let allTherapists = [];
        let allPatients = [];
        let allBookings = [];

        // Initialize dashboard
        async function initDashboard() {
            const auth = await guardDashboard('admin');
            if (!auth) return;
            
            currentUser = auth.user;
            currentProfile = auth.profile;
            
            // Load all data
            await Promise.all([
                loadPlatformStats(),
                loadPendingApplications(),
                loadAllTherapists(),
                loadAllPatients(),
                loadAllBookings()
            ]);
            
            // Setup event listeners
            setupEventListeners();
        }

        // Load platform statistics
        async function loadPlatformStats() {
            try {
                // Count therapists
                const { count: therapistCount, error: therapistError } = await supabaseClient
                    .from('Therapists')
                    .select('*', { count: 'exact', head: true });
                
                // Count patients
                const { count: patientCount, error: patientError } = await supabaseClient
                    .from('profiles')
                    .select('*', { count: 'exact', head: true })
                    .eq('role', 'user');
                
                // Count bookings
                const { count: bookingCount, error: bookingError } = await supabaseClient
                    .from('Bookings')
                    .select('*', { count: 'exact', head: true });
                
                // Calculate revenue (sum of completed bookings)
                const { data: revenueData, error: revenueError } = await supabaseClient
                    .from('Bookings')
                    .select('amount')
                    .eq('status', 'completed');
                
                const totalRevenue = revenueData ? revenueData.reduce((sum, b) => sum + (b.amount || 0), 0) : 0;
                
                // Update stats display
                document.getElementById('stat-therapists').textContent = therapistCount || 0;
                document.getElementById('stat-patients').textContent = patientCount || 0;
                document.getElementById('stat-bookings').textContent = bookingCount || 0;
                document.getElementById('stat-revenue').textContent = formatCurrency(totalRevenue);
                
            } catch (error) {
                console.error('Error loading platform stats:', error);
            }
        }

        // Load pending therapist applications
        async function loadPendingApplications() {
            const container = document.getElementById('pending-container');
            
            try {
                const { data: pending, error } = await supabaseClient
                    .from('Therapists')
                    .select('*')
                    .eq('approval_status', 'pending')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading pending applications:', error);
                    container.innerHTML = '<div class="alert alert-error">Failed to load pending applications.</div>';
                    return;
                }
                
                if (!pending || pending.length === 0) {
                    container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">No pending applications.</p>';
                    return;
                }
                
                container.innerHTML = '<div class="bookings-list">' + pending.map(therapist => `
                    <div class="booking-card">
                        <div class="booking-header">
                            <div>
                                <div class="booking-title">${therapist.Name}</div>
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${therapist.email}</div>
                            </div>
                            <span class="badge badge-pending">Pending</span>
                        </div>
                        <div class="booking-body">
                            <div class="booking-meta">
                                <span>ðŸŽ“ ${therapist.Specialization}</span>
                                <span>ðŸ“… ${therapist.experience || 0} years exp</span>
                                <span>ðŸ’° $${therapist.fee}/session</span>
                            </div>
                            <div style="margin-top: var(--spacing-md);">
                                <strong>License:</strong> ${therapist.license || 'N/A'}
                            </div>
                            <div style="margin-top: var(--spacing-sm); padding: var(--spacing-md); background-color: var(--bg-secondary); border-radius: var(--border-radius);">
                                <strong>Bio:</strong> ${therapist.bio || 'No bio provided'}
                            </div>
                        </div>
                        <div class="booking-footer">
                            <div style="font-size: var(--font-size-sm); color: var(--text-light);">
                                Applied on ${formatDate(therapist.created_at)}
                            </div>
                            <div class="booking-actions">
                                <button class="btn btn-success btn-sm" onclick="approveTherapist('${therapist.id}')">Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectTherapist('${therapist.id}')">Reject</button>
                            </div>
                        </div>
                    </div>
                `).join('') + '</div>';
                
            } catch (error) {
                console.error('Exception loading pending applications:', error);
                container.innerHTML = '<div class="alert alert-error">An error occurred.</div>';
            }
        }

        // Load all therapists
        async function loadAllTherapists() {
            try {
                const { data: therapists, error } = await supabaseClient
                    .from('Therapists')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading therapists:', error);
                    return;
                }
                
                allTherapists = therapists || [];
                renderTherapistsTable();
                
                // Populate therapist filter for bookings
                const filterSelect = document.getElementById('booking-therapist-filter');
                filterSelect.innerHTML = '<option value="">All Therapists</option>' + 
                    allTherapists.map(t => `<option value="${t.id}">${t.Name}</option>`).join('');
                
            } catch (error) {
                console.error('Exception loading therapists:', error);
            }
        }

        // Render therapists table
        function renderTherapistsTable() {
            const searchTerm = document.getElementById('therapist-search').value.toLowerCase();
            const tbody = document.getElementById('therapists-table-body');
            
            let filtered = allTherapists.filter(t => {
                const name = (t.Name || '').toLowerCase();
                const spec = (t.Specialization || '').toLowerCase();
                const email = (t.email || '').toLowerCase();
                return name.includes(searchTerm) || spec.includes(searchTerm) || email.includes(searchTerm);
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No therapists found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(t => `
                <tr>
                    <td>${t.Name}</td>
                    <td>${t.email}</td>
                    <td>${t.Specialization}</td>
                    <td>$${t.fee}</td>
                    <td><span class="badge ${t.Active ? 'badge-approved' : 'badge-cancelled'}">${t.Active ? 'Active' : 'Inactive'}</span></td>
                    <td><span class="badge badge-${t.approval_status}">${t.approval_status}</span></td>
                    <td>
                        ${t.approval_status === 'pending' ? `
                            <button class="btn btn-success btn-sm" onclick="approveTherapist('${t.id}')">Approve</button>
                            <button class="btn btn-danger btn-sm" onclick="rejectTherapist('${t.id}')">Reject</button>
                        ` : t.approval_status === 'rejected' ? `
                            <button class="btn btn-success btn-sm" onclick="approveTherapist('${t.id}')">Approve</button>
                        ` : `
                            <button class="btn btn-danger btn-sm" onclick="rejectTherapist('${t.id}')">Revoke</button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        // Load all patients
        async function loadAllPatients() {
            try {
                const { data: patients, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('role', 'user')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading patients:', error);
                    return;
                }
                
                allPatients = patients || [];
                renderPatientsTable();
                
            } catch (error) {
                console.error('Exception loading patients:', error);
            }
        }

        // Render patients table
        function renderPatientsTable() {
            const searchTerm = document.getElementById('patient-search').value.toLowerCase();
            const tbody = document.getElementById('patients-table-body');
            
            let filtered = allPatients.filter(p => {
                const name = (p.full_name || '').toLowerCase();
                const email = (p.email || '').toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm);
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No patients found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(p => `
                <tr>
                    <td>${p.full_name || 'N/A'}</td>
                    <td>${p.email}</td>
                    <td>${p.phone || 'N/A'}</td>
                    <td>${p.city || 'N/A'}</td>
                    <td>${formatDate(p.created_at)}</td>
                </tr>
            `).join('');
        }

        // Load all bookings
        async function loadAllBookings() {
            try {
                const { data: bookings, error } = await supabaseClient
                    .from('Bookings')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading bookings:', error);
                    return;
                }
                
                allBookings = bookings || [];
                renderBookingsTable();
                loadRevenueBreakdown();
                
            } catch (error) {
                console.error('Exception loading bookings:', error);
            }
        }

        // Render bookings table
        function renderBookingsTable() {
            const therapistFilter = document.getElementById('booking-therapist-filter').value;
            const statusFilter = document.getElementById('booking-status-filter').value;
            const tbody = document.getElementById('bookings-table-body');
            
            let filtered = allBookings.filter(b => {
                if (therapistFilter && b.therapist_id !== therapistFilter) return false;
                if (statusFilter && b.status !== statusFilter) return false;
                return true;
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No bookings found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(b => {
                const therapist = allTherapists.find(t => t.id === b.therapist_id);
                const therapistName = therapist ? therapist.Name : 'Unknown';
                
                return `
                    <tr>
                        <td>${b.id.substring(0, 8)}...</td>
                        <td>${b.patient_name || 'Unknown'}</td>
                        <td>${therapistName}</td>
                        <td>${formatDate(b.session_date)}</td>
                        <td>${formatCurrency(b.amount)}</td>
                        <td><span class="badge badge-${b.status}">${b.status}</span></td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteBooking('${b.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load revenue breakdown
        async function loadRevenueBreakdown() {
            const completedBookings = allBookings.filter(b => b.status === 'completed');
            
            // By therapist
            const byTherapist = {};
            completedBookings.forEach(b => {
                const therapist = allTherapists.find(t => t.id === b.therapist_id);
                const name = therapist ? therapist.Name : 'Unknown';
                byTherapist[name] = (byTherapist[name] || 0) + (b.amount || 0);
            });
            
            document.getElementById('revenue-by-therapist').innerHTML = Object.entries(byTherapist)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, amount]) => `
                    <div style="display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--border-color);">
                        <span>${name}</span>
                        <span class="font-semibold">${formatCurrency(amount)}</span>
                    </div>
                `).join('') || '<p class="text-center" style="color: var(--text-secondary);">No revenue data</p>';
            
            // By specialization
            const bySpec = {};
            completedBookings.forEach(b => {
                const therapist = allTherapists.find(t => t.id === b.therapist_id);
                const spec = therapist ? therapist.Specialization : 'Unknown';
                bySpec[spec] = (bySpec[spec] || 0) + (b.amount || 0);
            });
            
            document.getElementById('revenue-by-specialization').innerHTML = Object.entries(bySpec)
                .sort((a, b) => b[1] - a[1])
                .map(([spec, amount]) => `
                    <div style="display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--border-color);">
                        <span>${spec}</span>
                        <span class="font-semibold">${formatCurrency(amount)}</span>
                    </div>
                `).join('') || '<p class="text-center" style="color: var(--text-secondary);">No revenue data</p>';
            
            // Monthly trend
            const byMonth = {};
            completedBookings.forEach(b => {
                const date = new Date(b.created_at);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                byMonth[monthKey] = (byMonth[monthKey] || 0) + (b.amount || 0);
            });
            
            document.getElementById('revenue-monthly').innerHTML = Object.entries(byMonth)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 6)
                .map(([month, amount]) => {
                    const [year, monthNum] = month.split('-');
                    const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    return `
                        <div style="display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--border-color);">
                            <span>${monthName}</span>
                            <span class="font-semibold">${formatCurrency(amount)}</span>
                        </div>
                    `;
                }).join('') || '<p class="text-center" style="color: var(--text-secondary);">No revenue data</p>';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Logout
            document.getElementById('logout-btn').addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.href = 'login.html';
            });
            
            // Search filters
            document.getElementById('therapist-search').addEventListener('input', debounce(renderTherapistsTable, 300));
            document.getElementById('patient-search').addEventListener('input', debounce(renderPatientsTable, 300));
            document.getElementById('booking-therapist-filter').addEventListener('change', renderBookingsTable);
            document.getElementById('booking-status-filter').addEventListener('change', renderBookingsTable);
        }

        // Approve therapist
        async function approveTherapist(therapistId) {
            if (!confirm('Approve this therapist?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('Therapists')
                    .update({
                        approval_status: 'approved',
                        Active: true
                    })
                    .eq('id', therapistId);
                
                if (error) {
                    console.error('Error approving therapist:', error);
                    alert('Failed to approve therapist. Please try again.');
                    return;
                }
                
                // Reload data
                await Promise.all([
                    loadPendingApplications(),
                    loadAllTherapists(),
                    loadPlatformStats()
                ]);
                
                showSuccess('Therapist approved successfully!');
                
            } catch (error) {
                console.error('Exception approving therapist:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Reject therapist
        async function rejectTherapist(therapistId) {
            if (!confirm('Reject this therapist?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('Therapists')
                    .update({
                        approval_status: 'rejected'
                    })
                    .eq('id', therapistId);
                
                if (error) {
                    console.error('Error rejecting therapist:', error);
                    alert('Failed to reject therapist. Please try again.');
                    return;
                }
                
                // Reload data
                await Promise.all([
                    loadPendingApplications(),
                    loadAllTherapists()
                ]);
                
                showSuccess('Therapist rejected.');
                
            } catch (error) {
                console.error('Exception rejecting therapist:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Delete booking
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('Bookings')
                    .delete()
                    .eq('id', bookingId);
                
                if (error) {
                    console.error('Error deleting booking:', error);
                    alert('Failed to delete booking. Please try again.');
                    return;
                }
                
                // Reload data
                await Promise.all([
                    loadAllBookings(),
                    loadPlatformStats()
                ]);
                
                showSuccess('Booking deleted.');
                
            } catch (error) {
                console.error('Exception deleting booking:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
